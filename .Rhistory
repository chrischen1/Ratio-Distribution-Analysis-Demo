multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
library(grid)
plots <- c(list(...), plotlist)
numPlots = length(plots)
if (is.null(layout)) {
layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),ncol = cols, nrow = ceiling(numPlots/cols))
}
if (numPlots==1) {
print(plots[[1]])
} else {
grid.newpage()
pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
for (i in 1:numPlots) {
matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,layout.pos.col = matchidx$col))
}
}
}
plot_distribution = function(ratio , title_name ,left_line,right_line,max_ratio = 6,text_size=12){
library(ggplot2)
ratio[ratio>max_ratio]=max_ratio
xlabel = c(sprintf("%.1f", round(seq(0,5.85,0.5),2)),paste(">",max_ratio,sep=""))
df = data.frame(ratio)
g1<-ggplot(df, aes(x=ratio)) + geom_histogram(binwidth=0.05, color="black", fill="cornflowerblue") +
geom_freqpoly(binwidth=0.05, size=0.5,col="gray24")+ theme_bw()  +
#xlim(0, max_ratio)+
# scale_fill_gradient("Frequency",low = "green", high = "red") +
labs(title=title_name, x="Ratio", y ="Frequency",family="sans")+
theme(plot.title = element_text(color="black", size=text_size,face="bold")) +
theme(legend.text = element_text( size=text_size),legend.title = element_text( size=text_size), legend.key.size = unit(1,"cm")) +
theme(axis.title = element_text(color="black", size=text_size),axis.text=element_text(size=text_size))+
theme(panel.grid.major = element_line(colour = "grey"),panel.grid.minor.y = element_blank())+
geom_vline(xintercept = c(left_line,1,right_line),color = "black", size=0.8)+theme(plot.title = element_text(hjust = 0.5))+
scale_x_continuous("Ratio",limits = c(-0.3,max_ratio+0.3),breaks = seq(0,max_ratio,0.5),  labels=xlabel,minor_breaks = seq(-0.3,max_ratio,0.1))
g1 = g1 + annotate("text", x = c(0.4,1.2,2.4),
y = ggplot_build(g1)$layout$panel_params[[1]]$y.range[2]*0.98,
label = sprintf("%.2f",round(c(left_line,1,right_line),2)),size=text_size*0.3,family="sans")
return(g1)
}
plot_distribution_pairs <- function(r,cis_genes,title_name = '',left_line = 0.67,right_line = 1.5,max_ratio = 6){
g <- multiplot(plotlist = list(plot_distribution(r[intersect(cis_genes,names(r))],title_name = 'Cis genes',left_line = left_line,right_line = right_line,max_ratio = max_ratio),
plot_distribution(r[!names(r)%in%cis_genes],title_name = 'Trans genes',left_line = left_line,right_line = right_line,max_ratio = max_ratio)))
return(g)
}
plot_scatter <- function(Fold_Change,Expre,P_Value,plot_title='',left_line=0.67,right_line=1.5,hide_black_dots =F,show_lines=T,cex=0.72,xlim=6,ylim=20){
# Red indicates P_Value<0.05 and log2Fold_Change<-1, green is P_Value<0.05 and log2Fold_Change>1)
# red indicates up regulated, green is downregulated
if(hide_black_dots){
plot(log2(Fold_Change), log2(Expre),col='white',
cex.main=2, main=plot_title,cex.main=1.35*cex,family="sans", pch=20, xlab= '', ylab="",cex.lab=1.35*cex, xlim=c(-xlim,xlim), ylim=c(0,xlim),cex.axis=1.35*cex)
}else{
plot(log2(Fold_Change), log2(Expre),cex=cex,main=plot_title,cex.main=1.35*cex,family="sans", pch=20, xlab= '', ylab="",cex.lab=1.35*cex, xlim=c(-xlim,xlim), ylim=c(0,20),cex.axis=1.35*cex)
}
title(xlab="log"["2"]~"(Fold Change)", cex.lab=1.35*cex,line=2.5,family="sans")
title(ylab=("log"["2"]~"(Average Expression)"), cex.lab=1.35*cex,line=2.5,family="sans")
#lines
if(show_lines){
abline(v=log2(right_line),lty=3,lwd=2,col='black')
text(log2(2)+0.5,0, paste0("",right_line), col = "black", adj = c(0, -.1),cex=1.5*cex)
abline(v=log2(left_line),lty=3,lwd=2,col='black')
text(log2(0.5)-0.9,0, paste0("",left_line), col = "black", adj = c(0, -.1),cex=1.5*cex)
}
abline(v=log2(1),lty=3,lwd=2,col='black')
# text(0,0, paste("",0), col = "black", adj = c(0, -.1),cex=1.5*cex)
up_ind <- P_Value<.05 & log2(Fold_Change) > 0
down_ind <- P_Value<.05 & log2(Fold_Change) < 0
points(log2(Fold_Change)[up_ind], log2(Expre)[up_ind], pch=20, col="red",cex=cex)
points(log2(Fold_Change)[down_ind], log2(Expre)[down_ind], pch=20, col="green",cex=cex)
}
plot_scatter_pairs <- function(Fold_Change,Expre,P_Value,cis_genes,plot_title='',left_line=0.67,right_line=1.5,hide_black_dots =F,show_lines=T,cex=1.2,xlim=6,ylim=20){
par(mfrow=c(2,1))
trans_genes <- names(Fold_Change)[!names(Fold_Change)%in%cis_genes]
plot_scatter(Fold_Change = Fold_Change[cis_genes],plot_title='Cis genes',Expre = Expre[cis_genes],P_Value = P_Value[cis_genes],left_line = left_line,right_line = right_line)
plot_scatter(Fold_Change = Fold_Change[trans_genes],plot_title='Trans genes',Expre = Expre[trans_genes],P_Value = P_Value[trans_genes],left_line = left_line,right_line = right_line)
par(mfrow=c(1,1))
}
plot_distribution = function(ratio , title_name ,left_line,right_line,max_ratio = 6,text_size=12){
library(ggplot2)
ratio[ratio>max_ratio]=max_ratio
xlabel = c(sprintf("%.1f", round(seq(0,5.85,0.5),2)),paste(">",max_ratio,sep=""))
df = data.frame(ratio)
g1<-ggplot(df, aes(x=ratio)) + geom_histogram(binwidth=0.05, color="black", fill="cornflowerblue") +
geom_freqpoly(binwidth=0.05, size=0.5,col="gray24")+ theme_bw()  +
#xlim(0, max_ratio)+
# scale_fill_gradient("Frequency",low = "green", high = "red") +
labs(title=title_name, x="Ratio", y ="Frequency",family="sans")+
theme(plot.title = element_text(color="black", size=text_size,face="bold")) +
theme(legend.text = element_text( size=text_size),legend.title = element_text( size=text_size), legend.key.size = unit(1,"cm")) +
theme(axis.title = element_text(color="black", size=text_size),axis.text=element_text(size=text_size))+
theme(panel.grid.major = element_line(colour = "grey"),panel.grid.minor.y = element_blank())+
geom_vline(xintercept = c(left_line,1,right_line),color = "black", size=0.8)+theme(plot.title = element_text(hjust = 0.5))+
scale_x_continuous("Ratio",limits = c(-0.3,max_ratio+0.3),breaks = seq(0,max_ratio,0.5),  labels=xlabel,minor_breaks = seq(-0.3,max_ratio,0.1))
g1 = g1 + annotate("text", x = c(0.4,1.2,2.4),
y = ggplot_build(g1)$layout$panel_params[[1]]$y.range[2]*0.96,
label = sprintf("%.2f",round(c(left_line,1,right_line),2)),size=text_size*0.3,family="sans")
return(g1)
}
library(edgeR)
source('plot_utils2.R')
rpkm_data <- rpkm(counts,gene.length=gene_length)
knitr::opts_chunk$set(echo = TRUE)
set.seed(2018)
cis_expect_peak = 1.2
trans_expect_peak = 0.99
count_mean = 200
count_sd = 100
num_trans = 1700
num_cis = 300
expect_reads <- round(abs(rnorm(n = num_trans+num_cis,mean = count_mean,sd = count_sd)))
expect_reads_treatment <- round(abs(c(expect_reads[1:num_cis]*rnorm(num_cis,cis_expect_peak,cis_expect_peak/4),expect_reads[(num_cis+1):length(expect_reads)]*rnorm(num_trans,trans_expect_peak,trans_expect_peak/4))))
counts <- NULL
for (i in 1:3) {
counts <- cbind(counts,rpois(n =  num_trans+num_cis,lambda = expect_reads))
}
for (i in 1:3) {
counts <- cbind(counts,rpois(n =  num_trans+num_cis,lambda = expect_reads_treatment))
}
colnames(counts) <- c('c1','c2','c3','t1','t2','t3') #3 controls and 3 treatments
cis_genes <- paste0('cis_gene',1:num_cis)
trans_genes <- paste0('trans_gene',1:num_trans)
rownames(counts) <- c(cis_genes,trans_genes)
gene_length <- abs(round(rnorm(n = 2000,mean = 800,sd = 400)))
head(counts)
library(edgeR)
source('plot_utils2.R')
rpkm_data <- rpkm(counts,gene.length=gene_length)
head(rpkm_data)
rpkm_data_filtered <- rpkm_data[apply(rpkm_data, 1, function(x)sum(x>0))>3,]
head(rpkm_data_filtered)
mean_control <- apply(rpkm_data_filtered[,1:3], 1, mean)
mean_treatment <- apply(rpkm_data_filtered[,4:6], 1, mean)
mean_control[mean_control==0] <- 10e-6
r <- mean_treatment/mean_control
distribution_plot <- plot_distribution(r,title_name = '',left_line = 0.67,right_line = 1.5)
plot(distribution_plot)
distribution_plot2 <- plot_distribution_pairs(r,cis_genes,title_name = '',left_line = 0.67,right_line = 1.5,max_ratio = 6)
source('https://raw.githubusercontent.com/chrischen1/rnaseq/master/de_rnaseq.R')
group_table <- data.frame('group'=rep('experiment1',6),
'condition'=c(rep('control',3),rep('treatment',3)),
'control'=c(rep(T,3),rep(F,3)))
rownames(group_table) <- colnames(counts)
de <- edgeR_wrapper(cnt = counts,grp_table = group_table)
de1 <- de$experiment1.treatment
head(de1)
avg_expre <- apply(rpkm_data, 1, mean)
plot_scatter(Fold_Change = 2^de1$logFC,Expre = avg_expre,P_Value = de1$FDR,left_line = 0.67,right_line = 1.5)
fc <- 2^de1$logFC
pval <- de1$FDR
names(fc) <- names(pval) <- names(avg_expre)
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
distribution_plot <- plot_distribution(r,title_name = '',left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
distribution_plot <- plot_distribution(r,title_name = '',left_line = 0.67,right_line = 1.5)
plot(distribution_plot)
distribution_plot2 <- plot_distribution_pairs(r,cis_genes,title_name = '',left_line = 0.67,right_line = 1.5,max_ratio = 6)
distribution_plot2 <- plot_distribution_pairs(r,cis_genes,title_name = '',left_line = 0.67,right_line = 1.5,max_ratio = 6)
source('plot_utils2.R')
distribution_plot2 <- plot_distribution_pairs(r,cis_genes,title_name = '',left_line = 0.67,right_line = 1.5,max_ratio = 6)
distribution_plot2 <- plot_distribution_pairs(r,cis_genes,title_name = '',left_line = 0.67,right_line = 1.5,max_ratio = 6)
distribution_plot2 <- plot_distribution_pairs(r,cis_genes,title_name = '',left_line = 0.67,right_line = 1.5,max_ratio = 6)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
```{r,fig.width=5.7, fig.height=4.27*1.5}
fc <- 2^de1$logFC
pval <- de1$FDR
names(fc) <- names(pval) <- names(avg_expre)
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
fc <- 2^de1$logFC
pval <- de1$FDR
names(fc) <- names(pval) <- names(avg_expre)
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
fc <- 2^de1$logFC
pval <- de1$FDR
names(fc) <- names(pval) <- names(avg_expre)
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
source('plot_utils2.R')
plot_scatter_pairs(Fold_Change = fc,Expre = avg_expre,P_Value = pval,cis_genes,left_line = 0.67,right_line = 1.5)
